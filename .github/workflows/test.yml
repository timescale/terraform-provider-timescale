# Terraform Provider testing workflow.
name: integration-tests
on:
  push:
    paths-ignore:
      - "README.md"
# Testing only needs permissions to read the repository contents.
permissions:
  contents: read
jobs:
  # Ensure project builds before running testing matrix
  build:
    name: Build
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - uses: actions/checkout@v4 # v3.3.0
      - uses: cachix/install-nix-action@v26
      - uses: cachix/cachix-action@v14
        with:
          name: devenv
      - name: Install devenv.sh
        run: nix profile install nixpkgs#devenv
      - run: devenv shell run_mod_download
      - run: devenv shell run_build
  generate:
    name: Generate
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4 # v3.3.0
      - uses: cachix/install-nix-action@v26
      - uses: cachix/cachix-action@v14
        with:
          name: devenv
      - name: Install devenv.sh
        run: nix profile install nixpkgs#devenv
      - run: devenv shell run_mod_download
      - run: devenv shell run_generate
      - run: devenv shell run_diff
  test:
    name: Acceptance Tests
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - uses: actions/checkout@v4
      - uses: cachix/install-nix-action@v26
      - uses: cachix/cachix-action@v14
        with:
          name: devenv
      - name: Install devenv.sh
        run: nix profile install nixpkgs#devenv

      - run: go mod download
      - env:
          TF_ACC: "1"
          TF_VAR_ts_access_key: ${{ secrets.TF_VAR_TS_ACCESS_KEY }}
          TF_VAR_ts_secret_key: ${{ secrets.TF_VAR_TS_SECRET_KEY }}
          TF_VAR_ts_project_id: ${{ secrets.TF_VAR_TS_PROJECT_ID }}
          TF_VAR_ts_aws_acc_id: ${{ secrets.TF_VAR_TS_AWS_ACC_ID }}
          # point to API
          TIMESCALE_DEV_URL: ${{ secrets.TIMESCALE_DEV_URL }}
        run: devenv test
        timeout-minutes: 10
